---
title: "Porous use case"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Porous use case}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Intro
This poorly written vignette contains one working example of how to run the model in its current state.  
The code is organized in a series of functions.


```{r,echo=FALSE, fig.height = 3, fig.width = 7}
library(DiagrammeR)
DiagrammeR::grViz("digraph {

graph [layout = dot, rankdir = LR]
# define the global styles of the nodes. We can override these in box if we wish
node [shape = rectangle, style = filled, fillcolor = Linen]

Delta_z [label =  'Delta_z function', fillcolor = cornflowerblue]
phi_mat [label = 'phi_mat function', fillcolor = darkseagreen3]
phi_mic [label = 'phi_mic function', fillcolor = bisque2]
f_text_mic_func [label = 'f_text_mic_func function', fillcolor = mediumpurple1]
Porous [label = 'Porous function', fillcolor = darkorange]
pore_frac [label= 'pore_frac function', fillcolor = goldenrod2]

# edge definitions with the node IDs
Delta_z -> phi_mat -> pore_frac
Delta_z -> phi_mic -> pore_frac
f_text_mic_func -> phi_mic
pore_frac -> Porous
}")
```



## Example: how to to run the model.

```{r setup}
library(Porous)
library(SoilR) #this should load automatically anyway since it is required by Porous
```

First we create the model object:
```{r}
 modelObject<-Porous()
```
This creates a model with the default parameters. The parameter values can also be specified by the user (when one value is not specified the parameter will have default value), such as:

```{r}
modelObject<-Porous(ky=0.8, ko=0.00605,
                    kmix=0.9,
                    e=0.13,
                    Im=1.1, Ir=0.5,
                    F_prot=0.0,
                    phi_mac=0.2,
                    phi_min=1,
                    clay=0.2,
                    Delta_z_min=20,
                    gamma_o=1.2)

```
Many values can be omitted, and the function will use the defaults. In particular `f_text_mic `, if omitted, will be calculated internally with a specific function, `f_text_mic_func()`.

`SoilR` has an internal function designed to plot any model (but fluxes do not always seem consistent in the representation):

```{r, fig.height = 7, fig.width = 7}
plotPoolGraph(modelObject)
```

Now we can run the model, for wich we need to initialize the starting values
```{r}
init<-c(My_mes=1, Mo_mes=10,My_mic=0.6, Mo_mic=3)
times<-seq(0,20,by=0.1)
```

We can then run the model with the specific `SoilR` function:
```{r}
modrun0<-Model_by_PoolNames(smod=modelObject, times=times, initialValues=init)
```

And, again relying on  the specific `SoilR` function, we can extract the C stocks and respiration fluxes:

```{r}
Stocks<-getC(modrun0)
Resp<-getReleaseFlux(modrun0)
```
Let's see what object we created (by plotting just the first rows of it):
```{r}
head(Resp)
```

Everything seems in order and we can proceed to plot:
```{r fig1, fig.height = 8, fig.width = 6}
par(mfrow=c(2,1), mar=c(4,4,0,1))
matplot(times, Stocks, type="l", lty=1, col=1:4, xlab=" ", ylab="Pool contents", bty="n")
legend("bottomright", c("My_mes", "Mo_mes", "My_mic", "Mo_mic"), lty=1, col=1:4, bty="n")
matplot(times, Resp,  type="l", lty=1, col=1:2, xlab="Time", ylab="Respiration", bty="n")
```
